{% extends 'base.html' %}
{% load static %}
{% load query_filters %}

{% block title %}Adopt - PawPal{% endblock %}
{% block extra_head %}
<style>
  .timeline-list {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
  }

  .timeline-item {
    display: contents;
  }

  .timeline-circle {
    grid-column: 1;
    background-color: #d55e00;
    color: white;
    font-weight: bold;
    width: 32px;
    height: 32px;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Lexend', sans-serif;
    position: relative;
  }

  .timeline-content {
    grid-column: 2;
    padding-bottom: 1rem;
  }

  .timeline-circle::after {
    content: "";
    position: absolute;
    top: 32px;
    left: 50%;
    transform: translateX(-50%);
    height: calc(100% - 32px);
    width: 2px;
    background-color: #d55e00;
  }

        </svg>
      </button>
    </div>
    {% empty %}
      <p class="text-gray-500 col-span-full text-center">No animals found.</p>
    {% endfor %}
  </div>
</div>

<!-- Pet Modal -->
<div id="petModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex justify-center items-center">
  <div class="bg-white rounded-2xl max-w-lg w-full p-6 relative">
    <button onclick="closePetModal()" class="absolute top-3 right-3 text-gray-600 hover:text-red-500 text-2xl">&times;</button>
    <div id="petModalContent">
      <!-- JS dynamically fills this -->
    </div>
  </div>
</div>

<!-- Favorite JS (localStorage) -->
<script>
  function toggleFavorite(petId) {
    let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
    const index = favorites.indexOf(petId);
    if (index > -1) {
      favorites.splice(index, 1);
    } else {
      favorites.push(petId);
    }
    localStorage.setItem("favorites", JSON.stringify(favorites));
    updateHeartIcons();
  }

  function updateHeartIcons() {
    const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
    document.querySelectorAll("[id^='heart-']").forEach(el => {
      const petId = el.id.replace("heart-", "");
      el.style.color = favorites.includes(petId) ? "#e53935" : "gray";
    });
  }

  function openPetModal(petId) {
    fetch(`/api/pet/${petId}/`)  // backend endpoint to return pet JSON
      .then(res => res.json())
      .then(data => {
        document.getElementById('petModalContent').innerHTML = `
          <div class="text-center">
            <img src="${data.image_url}" alt="${data.name}" class="w-40 h-40 object-cover mx-auto mb-4 rounded-xl">
            <h3 class="text-2xl font-bold text-[#6d4c41]">${data.name}</h3>
            <p class="text-sm text-gray-600">Breed: ${data.breed}</p>
            <p class="text-sm text-gray-600">Color: ${data.color}</p>
            <p class="text-sm text-gray-600">Age: ${data.age} ${data.age_unit}</p>
            <p class="text-sm text-gray-600 mb-2">ID: ${data.pet_id}</p>
            <p class="text-sm text-gray-800 mb-4">${data.story}</p>
            ${data.is_medical ? `
              <div class="mb-4">
                <div class="w-full bg-gray-200 h-2 rounded-full">
                  <div class="bg-[#6d9f71] h-2 rounded-full" style="width: ${data.progress}%"></div>
                </div>
                <p class="text-xs text-gray-600 mt-1">Medical Help: ${data.progress}% funded</p>
                <p class="text-xs text-red-600">${data.medical_description}</p>
              </div>
            ` : ''}
            <button onclick="closePetModal()" class="mt-4 px-6 py-2 bg-[#d55e00] text-white rounded-full">Close</button>
          </div>
        `;
        document.getElementById('petModal').classList.remove('hidden');
      });
  }

  function closePetModal() {
    document.getElementById('petModal').classList.add('hidden');
  }

  document.addEventListener("DOMContentLoaded", updateHeartIcons);
</script>

{% endblock %}
