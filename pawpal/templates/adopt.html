{% extends 'base.html' %}
{% load static %}
{% load query_filters %}

{% block title %}Adopt - PawPal{% endblock %}
{% block extra_head %}
<style>
  .timeline-list {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
  }

  .timeline-item {
    display: contents;
  }

  .timeline-circle {
    grid-column: 1;
    background-color: #d55e00;
    color: white;
    font-weight: bold;
    width: 32px;
    height: 32px;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Lexend', sans-serif;
    position: relative;
  }

  .timeline-content {
    grid-column: 2;
    padding-bottom: 1rem;
  }

  .timeline-circle::after {
    content: "";
    position: absolute;
    top: 32px;
    left: 50%;
    transform: translateX(-50%);
    height: calc(100% - 32px);
    width: 2px;
    background-color: #d55e00;
  }

  .timeline-item:last-child .timeline-circle::after {
    display: none;
  }

  .step-circle {
    background-color: #d55e00;
    color: white;
    font-weight: bold;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    font-family: 'Lexend', sans-serif;
  }
</style>
{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto py-10 px-4">
  <h1 class="text-4xl font-bold text-center text-[#523a28] mb-10" style="font-family: 'Lexend', sans-serif;">Meet Your New Best Friend</h1>

  <!-- Layout: Sidebar + Content -->

  <div class="flex flex-col lg:flex-row gap-8 min-h-screen">
    <!-- Sidebar Filter -->
    <aside class="lg:w-1/4 bg-white rounded-lg shadow p-6 flex flex-col min-h-full">
    <form method="GET" id="filterForm" class="space-y-4">
      <!-- Search Box -->
      <input type="text" name="q" placeholder="Search by name, breed, color, ID..." value="{{ request.GET.q }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-300">
  
      <!-- Species -->
      <div>
        <label class="block font-semibold text-sm text-[#6d4c41] mb-1">Species</label>
        <select name="species" onchange="this.form.submit()" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
            <option value="">All ({{ species_counts|get_item:'dog'|default:0|add:species_counts|get_item:'cat'|default:0 }})</option>
            <option value="dog" {% if species == 'dog' %}selected{% endif %}>
              Dog ({{ species_counts|get_item:'dog'|default:0 }})
            </option>
            <option value="cat" {% if species == 'cat' %}selected{% endif %}>
              Cat ({{ species_counts|get_item:'cat'|default:0 }})
            </option>
        </select>
      </div>
      
      favorites.push(petId);
    }
    localStorage.setItem("favorites", JSON.stringify(favorites));
    updateHeartIcons();
  }

  function updateHeartIcons() {
    const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
    document.querySelectorAll("[id^='heart-']").forEach(el => {
      const petId = el.id.replace("heart-", "");
      el.style.color = favorites.includes(petId) ? "#e53935" : "gray";
    });
  }

  function openPetModal(petId) {
    fetch(`/api/pet/${petId}/`)  // backend endpoint to return pet JSON
      .then(res => res.json())
      .then(data => {
        document.getElementById('petModalContent').innerHTML = `
          <div class="text-center">
            <img src="${data.image_url}" alt="${data.name}" class="w-40 h-40 object-cover mx-auto mb-4 rounded-xl">
            <h3 class="text-2xl font-bold text-[#6d4c41]">${data.name}</h3>
            <p class="text-sm text-gray-600">Breed: ${data.breed}</p>
            <p class="text-sm text-gray-600">Color: ${data.color}</p>
            <p class="text-sm text-gray-600">Age: ${data.age} ${data.age_unit}</p>
            <p class="text-sm text-gray-600 mb-2">ID: ${data.pet_id}</p>
            <p class="text-sm text-gray-800 mb-4">${data.story}</p>
            ${data.is_medical ? `
              <div class="mb-4">
                <div class="w-full bg-gray-200 h-2 rounded-full">
                  <div class="bg-[#6d9f71] h-2 rounded-full" style="width: ${data.progress}%"></div>
                </div>
                <p class="text-xs text-gray-600 mt-1">Medical Help: ${data.progress}% funded</p>
                <p class="text-xs text-red-600">${data.medical_description}</p>
              </div>
            ` : ''}
            <button onclick="closePetModal()" class="mt-4 px-6 py-2 bg-[#d55e00] text-white rounded-full">Close</button>
          </div>
        `;
        document.getElementById('petModal').classList.remove('hidden');
      });
  }

  function closePetModal() {
    document.getElementById('petModal').classList.add('hidden');
  }

  document.addEventListener("DOMContentLoaded", updateHeartIcons);
</script>

{% endblock %}
